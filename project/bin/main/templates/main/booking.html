<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì˜í™” ì˜ˆë§¤ ì‹œìŠ¤í…œ</title>
<style>
body {
	font-family: Arial, sans-serif;
	background-color: #242333;
	color: #fff;
	margin: 0;
	padding: 20px;
}

.container {
	display: flex;
	justify-content: space-between;
	gap: 10px;
}

.section {
	background-color: #2f2d3b;
	border-radius: 8px;
	flex: 1;
	margin: 5px;
	overflow: auto;
	height: 420px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

.section h3 {
	color: #fff;
	padding: 8px;
	background: #3e3c4e;
	margin: 0;
	text-align: center;
}

.item {
	color: #ddd;
	padding: 8px;
	cursor: pointer;
	border-bottom: 1px solid #444;
	transition: all 0.3s;
}

.item:hover {
	background-color: #57556c;
}

.item.selected {
	background-color: #6bc1f2;
	color: #fff;
}

#seatBtn {
	display: none;
	width: 100%;
	padding: 10px;
	margin-top: 10px;
	background-color: #6bc1f2;
	border: none;
	color: white;
	cursor: pointer;
	border-radius: 4px;
}
</style>
</head>
<body>
	<div class="container">
		<!-- ì˜í™” ì„ íƒ -->
		<div class="section" id="movies">
			<h3>ì˜í™” ì„ íƒ</h3>
			<div class="list">
				<div class="item" th:each="movie:${movies}" th:data-id="${movie.id}"
					th:text="${movie.title}"></div>
			</div>
		</div>

		<!-- ê·¹ì¥ ì„ íƒ -->
		<div class="section" id="theaters">
			<h3>ê·¹ì¥ ì„ íƒ</h3>
			<div class="list">
				<div class="item" th:each="theater : ${theaters}"
					th:data-id="${theater.id}"
					th:text="${theater.location + ' - ' + theater.name}"></div>
			</div>
		</div>

		<!-- ë‚ ì§œ ì„ íƒ -->
		<div class="section" id="dates">
			<h3>ë‚ ì§œ ì„ íƒ</h3>
			<div class="list">
				<div class="item" th:each="day : ${#numbers.sequence(14,30)}"
					th:data-date="${'2025-03-' + (day < 10 ? '0'+day : day)}"
					th:text="${'2025-03-' + (day < 10 ? '0'+day : day)}"></div>
			</div>
		</div>

		<!-- ì‹œê°„ ì„ íƒ -->
		<div class="section" id="times">
			<h3>ì‹œê°„ ì„ íƒ</h3>
			<div class="list" id="timeList">ì˜í™”, ê·¹ì¥, ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
			<button id="seatBtn" style="display: none;">ì¢Œì„ ì„ íƒí•˜ê¸°</button>
		</div>
	</div>

	<script>
    const selected = { movieId: null, theaterId: null, date: null, screeningId: null };

    function addEvent(section, type) {
        document.querySelectorAll(`#${section} .item`).forEach(el => {
            el.onclick = () => {
                document.querySelectorAll(`#${section} .item`).forEach(i => i.classList.remove('selected'));
                el.classList.add('selected');
                selected[type] = el.getAttribute(type === 'date' ? 'data-date' : 'data-id');
                selected.screeningId = null; // ìƒì˜ ì‹œê°„ ì„ íƒ ì „ ì´ˆê¸°í™”
                document.getElementById('seatBtn').style.display = 'none';
                loadTimes();
                console.log("ğŸ” ì„ íƒëœ ì •ë³´:", selected);
            };
        });
    }

    addEvent('movies', 'movieId');
    addEvent('theaters', 'theaterId');
    addEvent('dates', 'date');

    function loadTimes() {
        const { movieId, theaterId, date } = selected;

        if (movieId && theaterId && date) {
            fetch(`/booking/screenings?movieId=${movieId}&theaterId=${theaterId}&date=${date}`)
                .then(res => res.json())
                .then(data => {
                    console.log("ë°›ì€ ìƒì˜ ì‹œê°„ ë°ì´í„°:", data);
                    const timeList = document.querySelector("#times .list");
                    timeList.innerHTML = '';

                    if (data.length === 0) {
                        timeList.innerHTML = "ìƒì˜ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.";
                        return;
                    }

                    data.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'item';
                        div.textContent = s.screenTime; // HH:mm í˜•ì‹
                        div.onclick = () => {
                            document.querySelectorAll('#timeList .item').forEach(i => i.classList.remove('selected'));
                            div.classList.add('selected');
                            selected.screeningId = s.id; // ì„ íƒëœ ìƒì˜ ID ì €ì¥
                            console.log("ì„ íƒëœ ìƒì˜ ID:", selected.screeningId);
                            document.getElementById('seatBtn').style.display = 'block'; // ë²„íŠ¼ í™œì„±í™”
                        };
                        timeList.appendChild(div);
                    });
                })
                .catch(error => console.error("ìƒì˜ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
        }
    }

    document.getElementById('seatBtn').onclick = () => {
        if (selected.screeningId) {
            console.log("ì´ë™í•  URL:", `/select-seat?screeningId=${selected.screeningId}`);
            location.href = `/select-seat?screeningId=${selected.screeningId}`;
        } else {
            alert('ìƒì˜ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
    };
</script>

</body>
</html>
